generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

enum SiteThemes {
	light
	dark
}

enum AuthMethods {
	blue_dot
	google
}

model credentials {
	user_id                                                     Int      @id @default(autoincrement())
	username                                                    String?     @unique
	age 														Int?

	password                                                    String?
	is_active                                                   Boolean  @default(true)
	default_site_theme                                          SiteThemes
	sandbox_notes_open											Boolean @default(false)

	auth_method                                                 AuthMethods

	email__encrypted                                            String @unique
	name														String?

	created_at                                                  DateTime @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	login_history                                               login_history[]
	sandbox_project												sandbox_project[]
	challenge_chat												challenge_chat[]
	career_chat													career_chat[]	
	challenge_sandbox											challenge_sandbox[]
	student														student[]
	teacher														teacher?
	profile_picture												profile_picture?
	challenge_code_submission									challenge_code_submission[]
	challenge_hint												challenge_hint[]
	career_user_progress										career_user_progress[]
	user_seen_challenges										user_seen_challenges[]
	block_to_function_user_answer								block_to_function_user_answer[]
	function_to_block_user_answer								function_to_block_user_answer[]
	fill_in_the_blank_user_answer								fill_in_the_blank_user_answer[]
	completed_user_lesson										completed_user_lesson[]
}

model login_history {
	login_history_id                                            Int       @id @default(autoincrement())
	user_id                                                     Int
	login_time                                                  DateTime  @default(now())

	user                                                        credentials @relation(fields: [user_id], references: [user_id])

	@@index([user_id], name: "login_history__user_id_idx")
}

model pip_uuid {
	pip_uuid_id                                            		Int       @id @default(autoincrement())
	uuid														String		@unique
	hardware_version											String
	pip_name													String?

	created_at                                                  DateTime  @default(now())

	@@index([uuid], name: "pip_uuid__uuid_idx")
}

model email_update_subscriber {
	email_update_subscriber_id									Int       @id @default(autoincrement())
	email__encrypted                                            String @unique

	created_at                                                  DateTime  @default(now())
	is_active                                                   Boolean  @default(true)
}

model sandbox_project {
	sandbox_project_id											Int       @id @default(autoincrement())
	sandbox_json												Json
	project_owner_id       										Int
	project_uuid												String		@unique
	project_name												String?
	project_notes												String?
	is_starred													Boolean @default(false)

	is_active													Boolean @default(true)

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [project_owner_id], references: [user_id])
	sandbox_chat												sandbox_chat[]

	@@index([project_owner_id], name: "sandbox_project__project_owner_id_idx")
	@@index([project_uuid], name: "sandbox_project__project_uuid_idx")
}

model profile_picture {
	profile_picture_id                                          Int @id @default(autoincrement())
	image_url                                                   String
	file_name                                                   String
	uuid                                                        String
  	user_id             										Int    @unique

	is_active                                                   Boolean  @default(true)

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime  @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
}

model challenge_chat {
	challenge_chat_id  											Int      @id @default(autoincrement())
	challenge_id       											Int
	user_id               										Int

	created_at            										DateTime @default(now())
	updated_at            										DateTime @default(now()) @updatedAt
	is_active													Boolean @default(true)

	user                  										credentials @relation(fields: [user_id], references: [user_id])
	challenge													challenge @relation(fields: [challenge_id], references: [challenge_id])
	messages              										challenge_message[]

  	@@index([challenge_id, user_id, is_active], name: "challenge_chat__challenge_user_active_idx")
}

model career_chat {
	career_chat_id  											Int      @id @default(autoincrement())
	career_id       											Int
	user_id               										Int

	created_at            										DateTime @default(now())
	updated_at            										DateTime @default(now()) @updatedAt
	is_active													Boolean @default(true)

	user                  										credentials @relation(fields: [user_id], references: [user_id])
	career														career @relation(fields: [career_id], references: [career_id])
	messages              										career_message[]

	@@index([career_id, user_id, is_active], name: "career_chat__career_user_active_idx")
	@@index([career_id], name: "career_chat__career_id_idx")
}

model sandbox_chat {
	sandbox_chat_id       										Int      @id @default(autoincrement())
	sandbox_project_id    										Int      // Multiple chats per sandbox project

	created_at            										DateTime @default(now())
	updated_at            										DateTime @default(now()) @updatedAt
	is_active													Boolean @default(true)

	sandbox_project       										sandbox_project @relation(fields: [sandbox_project_id], references: [sandbox_project_id])
	messages              										sandbox_message[]
}

enum MessageSender {
	USER
	AI
}

model challenge_message {
	challenge_message_id   										Int           @id @default(autoincrement())
	message_text              									String
	sender                    									MessageSender
	model_used                									String?       // Only for AI messages

	challenge_chat_id      										Int

	created_at                									DateTime      @default(now())
	updated_at                									DateTime      @default(now()) @updatedAt

	challenge_chat         										challenge_chat @relation(fields: [challenge_chat_id], references: [challenge_chat_id])

	@@index([challenge_chat_id, created_at])
}

model career_message {
	career_message_id   										Int           @id @default(autoincrement())
	message_text              									String
	sender                    									MessageSender
	model_used                									String?       // Only for AI messages

	career_chat_id      										Int

	created_at                									DateTime      @default(now())
	updated_at                									DateTime      @default(now()) @updatedAt

	career_chat         										career_chat @relation(fields: [career_chat_id], references: [career_chat_id])
}

model challenge_hint {
	challenge_hint_id											Int       @id @default(autoincrement())
	challenge_id												Int
	user_id														Int
	
	hint_text													String
	model_used													String
	hint_number													Int

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	challenge													challenge @relation(fields: [challenge_id], references: [challenge_id])

	@@index([user_id])
	@@index([challenge_id, user_id])
	@@index([challenge_id, created_at])
}

model challenge_code_submission {
	submission_id                   							Int       @id @default(autoincrement())
	challenge_id            									Int
	user_id             										Int
	user_code                       							String    // The code they submitted
	is_correct                      							Boolean   // Quick access to the result
	score                           							Float     // How close to correct (0.0 - 1.0, where 1.0 is correct)
	feedback                        							String    // Short response like "Great job!" or "Not quite, try again"

	created_at                      							DateTime  @default(now())
	updated_at                      							DateTime  @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	challenge               									challenge @relation(fields: [challenge_id], references: [challenge_id])

	@@index([user_id])
	@@index([challenge_id, user_id])
	@@index([challenge_id, created_at])
}

model sandbox_message {
	sandbox_message_id        									Int           @id @default(autoincrement())
	message_text              									String
	sender                    									MessageSender
	model_used                									String?       // Only for AI messages
									
	sandbox_chat_id           									Int
									
	created_at                									DateTime      @default(now())
	updated_at                									DateTime      @default(now()) @updatedAt
									
	sandbox_chat              									sandbox_chat @relation(fields: [sandbox_chat_id], references: [sandbox_chat_id])

	@@index([sandbox_chat_id, created_at])
}

model challenge_sandbox {
	challenge_sandbox_id										Int       @id @default(autoincrement())
	challenge_sandbox_json										Json
	user_id			       										Int
	challenge_id												Int

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	challenge													challenge @relation(fields: [challenge_id], references: [challenge_id])

	@@index([user_id], name: "challenge_sandbox__user_id_idx")
	@@unique([user_id, challenge_id])
	@@index([challenge_id, user_id], name: "challenge_sandbox__challenge_user_idx")
	@@index([challenge_id], name: "challenge_sandbox__challenge_id_idx")
}

model career {
	career_id													Int       @id @default(autoincrement())
	career_name													String
	career_uuid													String		@unique

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	challenges													challenge[]
	career_user_progress										career_user_progress[]
	career_chat													career_chat[]
}

model challenge {
	challenge_id												Int       @id @default(autoincrement())
	challenge_name												String
	challenge_uuid												String		@unique

	career_id													Int
	career														career @relation(fields: [career_id], references: [career_id])

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	challenge_sandbox											challenge_sandbox[]
	challenge_chat												challenge_chat[]
	challenge_code_submission									challenge_code_submission[]
	challenge_hint												challenge_hint[]
	user_seen_challenges										user_seen_challenges[]

	@@index([career_id], name: "challenge__career_id_idx")
	@@index([career_id, created_at], name: "challenge__career_id_created_at_idx")
}

model career_user_progress {
	career_user_progress_id										Int       @id @default(autoincrement())
	user_id														Int
	career_id													Int
	current_challenge_uuid_or_text_uuid							String
	furthest_seen_challenge_uuid_or_text_uuid					String

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	career                                                    	career @relation(fields: [career_id], references: [career_id])

	@@index([user_id, career_id])
	@@unique([user_id, career_id])
}

model user_seen_challenges {
	user_seen_challenge_id  									Int      @id @default(autoincrement())
	user_id                 									Int
	challenge_id            									Int
	seen_at                 									DateTime @default(now())

	user      													credentials @relation(fields: [user_id], references: [user_id])
	challenge 													challenge @relation(fields: [challenge_id], references: [challenge_id])

	@@unique([user_id, challenge_id])
	@@index([user_id])
}

model classroom {
	classroom_id												Int       @id @default(autoincrement())
	classroom_name												String
	class_code													String		@unique

	classroom_teacher_map										classroom_teacher_map[]
	student														student[]

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt
}

model school {
    school_id	          										Int       @id @default(autoincrement())
	school_name													String @unique

	teachers													teacher[]

    created_at          										DateTime  @default(now())
    updated_at          										DateTime @default(now()) @updatedAt
}

model teacher {
    teacher_id          										Int       @id @default(autoincrement())
    user_id             										Int       @unique  // One teacher record per user
	teacher_first_name											String
	teacher_last_name											String
	school_id													Int

    is_approved         										Boolean?
    classroom_teacher_map   									classroom_teacher_map[]
    school														school @relation(fields: [school_id], references: [school_id])

	user                                                        credentials @relation(fields: [user_id], references: [user_id])

    created_at          										DateTime  @default(now())
    updated_at          										DateTime @default(now()) @updatedAt

    @@index([school_id], name: "teacher__school_id_idx")
}

model classroom_teacher_map {
    classroom_teacher_map_id    								Int       @id @default(autoincrement())
    teacher_id                  								Int
    classroom_id                								Int
								
    created_at                  								DateTime  @default(now())
    updated_at                  								DateTime  @default(now()) @updatedAt
								
    teacher                     								teacher @relation(fields: [teacher_id], references: [teacher_id])
    classroom                   								classroom @relation(fields: [classroom_id], references: [classroom_id])

    @@unique([classroom_id, teacher_id])
    @@index([teacher_id])
    @@index([classroom_id])
}

model student {
    student_id              									Int       @id @default(autoincrement())
    user_id                 									Int
    classroom_id            									Int
    joined_classroom_at     									DateTime? // Only set when ACCEPTED

    created_at          										DateTime  @default(now())
    updated_at          										DateTime  @default(now()) @updatedAt

	garage_driving_allowed										Boolean @default(true)
	garage_sounds_allowed										Boolean @default(true)
	garage_lights_allowed										Boolean @default(true)
	garage_display_allowed										Boolean @default(true)

    user                										credentials @relation(fields: [user_id], references: [user_id])
    classroom           										classroom @relation(fields: [classroom_id], references: [classroom_id])

    @@unique([user_id, classroom_id])
    @@index([classroom_id])
}

enum QuestionType {
	BLOCK_TO_FUNCTION
	FUNCTION_TO_BLOCK
	FILL_IN_BLANK
}

model question {
	question_id												String       @id @default(uuid())
	question_type											QuestionType
	
	created_at												DateTime     @default(now())
	updated_at												DateTime     @default(now()) @updatedAt
	
	// Polymorphic relations - only ONE will be populated
	block_to_function_flashcard								block_to_function_flashcard?
	function_to_block_flashcard								function_to_block_flashcard?
	fill_in_the_blank										fill_in_the_blank?
	
	lesson_question_map										lesson_question_map[]
}

model coding_block {
	coding_block_id											Int       @id @default(autoincrement())
	coding_block_json										Json @default("{}")

	created_at												DateTime  @default(now())
	
	block_to_function_flashcard								block_to_function_flashcard[]
	function_to_block_answer_choice							function_to_block_answer_choice[]
}

model lesson {
	lesson_id												String    @id @default(uuid())
	lesson_name												String
	lesson_description										String?
	
	created_at												DateTime  @default(now())
	updated_at												DateTime  @default(now()) @updatedAt
	
	lesson_question_map										lesson_question_map[]
	completed_user_lesson									completed_user_lesson[]
}

model lesson_question_map {
	lesson_question_map_id									Int       @id @default(autoincrement())
	lesson_id												String
	question_id												String
	order													Int
	
	lesson													lesson    @relation(fields: [lesson_id], references: [lesson_id])
	question												question  @relation(fields: [question_id], references: [question_id])
	
	@@unique([lesson_id, question_id])
	@@index([lesson_id, order])
}

model completed_user_lesson {
	completed_user_lesson_id								Int       @id @default(autoincrement())
	user_id													Int
	lesson_id												String
	
	created_at												DateTime  @default(now())
	
	user													credentials @relation(fields: [user_id], references: [user_id])
	lesson													lesson    @relation(fields: [lesson_id], references: [lesson_id])

	@@index([user_id])
	@@index([lesson_id])
}

model block_to_function_flashcard {
	question_id												String    @id
	coding_block_id											Int
	question_text											String @default("")
	
	question												question  @relation(fields: [question_id], references: [question_id], onDelete: Cascade)
	coding_block											coding_block @relation(fields: [coding_block_id], references: [coding_block_id])
	
	block_to_function_answer_choice							block_to_function_answer_choice[]
}

model block_to_function_answer_choice {
	block_to_function_answer_choice_id						Int       @id @default(autoincrement())
	block_to_function_flashcard_id							String
	function_description_text								String
	is_correct												Boolean
	order													Int
	
	block_to_function_flashcard								block_to_function_flashcard @relation(fields: [block_to_function_flashcard_id], references: [question_id], onDelete: Cascade)
	block_to_function_user_answer							block_to_function_user_answer[]
	
	@@index([block_to_function_flashcard_id])
}

model block_to_function_user_answer {
	block_to_function_user_answer_id						Int       @id @default(autoincrement())
	block_to_function_answer_choice_id						Int
	user_id													Int
	
	created_at												DateTime  @default(now())
	
	answer_choice											block_to_function_answer_choice @relation(fields: [block_to_function_answer_choice_id], references: [block_to_function_answer_choice_id])
	user													credentials @relation(fields: [user_id], references: [user_id])
	
	@@index([user_id])
	@@index([block_to_function_answer_choice_id])
}

model function_to_block_flashcard {
	question_id												String    @id
	question_text											String
	
	question												question  @relation(fields: [question_id], references: [question_id], onDelete: Cascade)
	
	function_to_block_answer_choice							function_to_block_answer_choice[]
}

model function_to_block_answer_choice {
	function_to_block_answer_choice_id						Int       @id @default(autoincrement())
	function_to_block_flashcard_id							String
	coding_block_id											Int
	is_correct												Boolean
	order													Int
	
	function_to_block_flashcard								function_to_block_flashcard @relation(fields: [function_to_block_flashcard_id], references: [question_id], onDelete: Cascade)
	coding_block											coding_block @relation(fields: [coding_block_id], references: [coding_block_id])
	function_to_block_user_answer							function_to_block_user_answer[]
	
	@@index([function_to_block_flashcard_id])
	@@index([coding_block_id])
}

model function_to_block_user_answer {
	function_to_block_user_answer_id						Int       @id @default(autoincrement())
	function_to_block_answer_choice_id						Int
	user_id													Int
	
	created_at												DateTime  @default(now())
	
	answer_choice											function_to_block_answer_choice @relation(fields: [function_to_block_answer_choice_id], references: [function_to_block_answer_choice_id])
	user													credentials @relation(fields: [user_id], references: [user_id])
	
	@@index([user_id])
	@@index([function_to_block_answer_choice_id])
}

model fill_in_the_blank {
	question_id												String    @id
	initial_blockly_json									Json
	reference_solution_cpp									String
	question_text											String
	
	question												question  @relation(fields: [question_id], references: [question_id], onDelete: Cascade)
	
	fill_in_the_blank_block_bank							fill_in_the_blank_block_bank[]
	fill_in_the_blank_user_answer							fill_in_the_blank_user_answer[]
}

model fill_in_the_blank_block_bank {
	fill_in_the_blank_block_bank_id							Int       @id @default(autoincrement())
	fill_in_the_blank_id									String
	block_name_id											Int
	
	fill_in_the_blank										fill_in_the_blank @relation(fields: [fill_in_the_blank_id], references: [question_id], onDelete: Cascade)
	block_name												block_name @relation(fields: [block_name_id], references: [block_name_id])
	
	@@index([fill_in_the_blank_id])
	@@index([block_name_id])
}

model fill_in_the_blank_user_answer {
	fill_in_the_blank_user_answer_id						Int       @id @default(autoincrement())
	fill_in_the_blank_id									String
	user_id													Int
	user_cpp_answer											String
	is_correct												Boolean
	
	created_at												DateTime  @default(now())
	
	fill_in_the_blank										fill_in_the_blank @relation(fields: [fill_in_the_blank_id], references: [question_id])
	user													credentials @relation(fields: [user_id], references: [user_id])
	
	@@index([user_id])
	@@index([fill_in_the_blank_id])
}

model block_name {
	block_name_id											Int       @id @default(autoincrement())
	block_name												String	  @unique

	created_at												DateTime  @default(now())

	fill_in_the_blank_block_bank							fill_in_the_blank_block_bank[]
}
