generator client {
	provider = "prisma-client-js"
}

datasource db {
	provider = "postgresql"
	url      = env("DATABASE_URL")
}

enum SiteThemes {
	light
	dark
}

enum AuthMethods {
	blue_dot
	google
}

model credentials {
	user_id                                                     Int      @id @default(autoincrement())
	username                                                    String?     @unique
	age 														Int?

	password                                                    String?
	is_active                                                   Boolean  @default(true)
	default_site_theme                                          SiteThemes
	sandbox_notes_open											Boolean @default(false)

	auth_method                                                 AuthMethods

	email__encrypted                                            String @unique
	name														String?

	created_at                                                  DateTime @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	login_history                                               login_history[]
	user_pip_uuid_map											user_pip_uuid_map[]
	user_activity_progress										user_activity_progress[]
	user_answer													user_answer[]
	completed_reading_block										completed_reading_block[]
	sandbox_project												sandbox_project[]
	career_quest_chat											career_quest_chat[]
	career_quest_sandbox										career_quest_sandbox[]
	student														student[]
	teacher														teacher?
	profile_picture												profile_picture?
}

model login_history {
	login_history_id                                            Int       @id @default(autoincrement())
	user_id                                                     Int
	login_time                                                  DateTime  @default(now())

	user                                                        credentials @relation(fields: [user_id], references: [user_id])

	@@index([user_id], name: "login_history__user_id_idx")
}

model pip_uuid {
	pip_uuid_id                                            		Int       @id @default(autoincrement())
	uuid														String		@unique
	hardware_version											String
	pip_name													String?

	created_at                                                  DateTime  @default(now())

	user_pip_uuid_map											user_pip_uuid_map[]
	@@index([uuid], name: "pip_uuid__uuid_idx")
}

model user_pip_uuid_map {
	user_pip_uuid_map_id										Int       @id @default(autoincrement())
  	user_id             										Int
	pip_uuid_id                                               	Int

	last_connection_time										DateTime @default(now())
	created_at                                                  DateTime  @default(now())
	is_active                                                   Boolean  @default(true)

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	pip_uuid                                                    pip_uuid @relation(fields: [pip_uuid_id], references: [pip_uuid_id])

	@@index([user_id], name: "user_pip_uuid_map__user_id_idx")
	@@index([pip_uuid_id], name: "user_pip_uuid_map__pip_uuid_id_idx")
	@@unique([user_id, pip_uuid_id])
}

model email_update_subscriber {
	email_update_subscriber_id									Int       @id @default(autoincrement())
	email__encrypted                                            String @unique

	created_at                                                  DateTime  @default(now())
	is_active                                                   Boolean  @default(true)
}

enum ActivityTypes {
	Reading
	Code
	Video
	Demo
	Summary
}

enum LessonNames {
	LED
	Motor
	IMU
	Button
}

// Reference Configuration data
model activity {
	activity_id													Int       @id @default(autoincrement())
	lesson_name													LessonNames
	activity_type	                                            ActivityTypes
	activity_uuid												String		@unique
	activity_name												String
	reading_block                                               reading_block[]

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt
	
	user_activity_progress										user_activity_progress[]
	reading_questions											reading_question[]
	@@unique([activity_type, activity_name])
	@@index([activity_uuid], name: "activity__activity_uuid_idx")
}

enum ProgressStatus {
	IN_PROGRESS
	COMPLETED
}

model user_activity_progress {
	user_activity_progress_id									Int       @id @default(autoincrement())
	user_id             										Int
	activity_id                                               	Int
  	status    													ProgressStatus

  	completed_at  												DateTime?
	created_at                                                  DateTime  @default(now())

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	activity                                                    activity @relation(fields: [activity_id], references: [activity_id])

	@@index([user_id], name: "user_activity_progress__user_id_idx")
	@@index([activity_id], name: "user_activity_progress__activity_id_idx")
	@@unique([user_id, activity_id])
}

// Reference Configuration data
model reading_block {
	reading_block_id											Int       @id @default(autoincrement())
	reading_id                                               	Int
  	reading_block_name    										String		@unique

	created_at                                                  DateTime  @default(now())

	reading                                                     activity @relation(fields: [reading_id], references: [activity_id])
	completed_reading_block										completed_reading_block[]
	@@index([reading_id], name: "reading_block__reading_id_idx")
}

model completed_reading_block {
	completed_reading_block_id									Int       @id @default(autoincrement())
	reading_block_id											Int
	user_id														Int

	created_at                                                  DateTime  @default(now())
	is_active													Boolean @default(true)

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	reading_block                                               reading_block @relation(fields: [reading_block_id], references: [reading_block_id])

	@@index([user_id], name: "completed_reading_block__user_id_idx")
	@@index([reading_block_id], name: "completed_reading_block__reading_block_id_idx")
	@@unique([user_id, reading_block_id])
}

// Reference Configuration data
model reading_question {
	reading_question_id											Int       @id @default(autoincrement())
	activity_id                                               	Int
	question_text												String
	reading_question_uuid										String		@unique

	created_at                                                  DateTime  @default(now())

	activity                                                    activity @relation(fields: [activity_id], references: [activity_id])
	reading_question_answer_choice								reading_question_answer_choice[]

	@@index([activity_id], name: "reading_question__activity_id_idx")
	@@unique([activity_id, question_text])
}

// Reference Configuration data
model reading_question_answer_choice {
	reading_question_answer_choice_id							Int       @id @default(autoincrement())
	reading_question_id                                         Int
	answer_text													String
	is_correct													Boolean
	explanation													String

	created_at                                                  DateTime  @default(now())

	reading_question                                            reading_question @relation(fields: [reading_question_id], references: [reading_question_id])
	user_answer												user_answer[]
	@@index([reading_question_id], name: "reading_question_answer_choice__reading_question_id_idx")
	@@unique([reading_question_id, answer_text])
}

model user_answer {
	user_answers_id												Int       @id @default(autoincrement())
	reading_question_answer_choice_id                           Int
	user_id             										Int

	created_at                                                  DateTime  @default(now())

	reading_question                                            reading_question_answer_choice @relation(fields: [reading_question_answer_choice_id], references: [reading_question_answer_choice_id])
	user                                                        credentials @relation(fields: [user_id], references: [user_id])

	@@index([reading_question_answer_choice_id], name: "user_answers__reading_question_answer_choice_id_idx")
	@@index([user_id], name: "user_answers__user_id_idx")
	@@unique([reading_question_answer_choice_id, user_id])
}

model sandbox_project {
	sandbox_project_id											Int       @id @default(autoincrement())
	sandbox_json												Json
	project_owner_id       										Int
	project_uuid												String		@unique
	project_name												String?
	project_notes												String?
	is_starred													Boolean @default(false)

	is_active													Boolean @default(true)

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [project_owner_id], references: [user_id])
	sandbox_chat												sandbox_chat[]

	@@index([project_owner_id], name: "sandbox_project__project_owner_id_idx")
	@@index([project_uuid], name: "sandbox_project__project_uuid_idx")
}

model profile_picture {
	profile_picture_id                                          Int @id @default(autoincrement())
	image_url                                                   String
	file_name                                                   String
	uuid                                                        String
  	user_id             										Int    @unique

	is_active                                                   Boolean  @default(true)

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime  @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
}

model career_quest_chat {
	career_quest_chat_id  										Int      @id @default(autoincrement())
	challenge_id       											Int
	user_id               										Int

	created_at            										DateTime @default(now())
	updated_at            										DateTime @default(now()) @updatedAt
	is_active													Boolean @default(true)

	user                  										credentials @relation(fields: [user_id], references: [user_id])
	messages              										career_quest_message[]
	code_submissions      										career_quest_code_submission[]
	career_quest_hints											career_quest_hint[]

	@@index([user_id, challenge_id])
	challenge													challenge @relation(fields: [challenge_id], references: [challenge_id])
}

model sandbox_chat {
	sandbox_chat_id       										Int      @id @default(autoincrement())
	sandbox_project_id    										Int      // Multiple chats per sandbox project

	created_at            										DateTime @default(now())
	updated_at            										DateTime @default(now()) @updatedAt
	is_active													Boolean @default(true)

	sandbox_project       										sandbox_project @relation(fields: [sandbox_project_id], references: [sandbox_project_id])
	messages              										sandbox_message[]
}

enum MessageSender {
	USER
	AI
}

model career_quest_message {
	career_quest_message_id   									Int           @id @default(autoincrement())
	message_text              									String
	sender                    									MessageSender
	model_used                									String?       // Only for AI messages
									
	career_quest_chat_id      									Int
									
	created_at                									DateTime      @default(now())
	updated_at                									DateTime      @default(now()) @updatedAt
									
	career_quest_chat         									career_quest_chat @relation(fields: [career_quest_chat_id], references: [career_quest_chat_id])

	@@index([career_quest_chat_id, created_at])
}

model career_quest_hint {
	career_quest_hint_id										Int       @id @default(autoincrement())
	career_quest_chat_id										Int
	hint_text													String
	model_used													String
	hint_number													Int

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	career_quest_chat               							career_quest_chat @relation(fields: [career_quest_chat_id], references: [career_quest_chat_id])

	@@index([career_quest_chat_id, created_at])
}

model career_quest_code_submission {
	submission_id                   							Int       @id @default(autoincrement())
	career_quest_chat_id            							Int
	user_code                       							String    // The code they submitted
	challenge_snapshot              							Json      // { title, description, expectedBehavior, solutionCode }
	is_correct                      							Boolean   // Quick access to the result
	score                           							Float     // How close to correct (0.0 - 1.0, where 1.0 is correct)
	feedback                        							String    // Short response like "Great job!" or "Not quite, try again"

	created_at                      							DateTime  @default(now())
	updated_at                      							DateTime  @default(now()) @updatedAt
								
	career_quest_chat               							career_quest_chat @relation(fields: [career_quest_chat_id], references: [career_quest_chat_id])
	@@index([career_quest_chat_id, created_at])
}

model sandbox_message {
	sandbox_message_id        									Int           @id @default(autoincrement())
	message_text              									String
	sender                    									MessageSender
	model_used                									String?       // Only for AI messages
									
	sandbox_chat_id           									Int
									
	created_at                									DateTime      @default(now())
	updated_at                									DateTime      @default(now()) @updatedAt
									
	sandbox_chat              									sandbox_chat @relation(fields: [sandbox_chat_id], references: [sandbox_chat_id])

	@@index([sandbox_chat_id, created_at])
}

model career_quest_sandbox {
	career_quest_sandbox_id										Int       @id @default(autoincrement())
	career_quest_sandbox_json									Json
	user_id			       										Int
	challenge_id												Int

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])
	challenge													challenge @relation(fields: [challenge_id], references: [challenge_id])

	@@index([user_id], name: "career_quest_sandbox__user_id_idx")
	@@unique([user_id, challenge_id])
}

model career {
	career_id													Int       @id @default(autoincrement())
	career_name													String
	career_uuid													String		@unique

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	challenges													challenge[]
}

model challenge {
	challenge_id												Int       @id @default(autoincrement())
	challenge_name												String
	challenge_uuid												String		@unique

	career_id													Int
	career														career @relation(fields: [career_id], references: [career_id])

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	career_quest_sandbox										career_quest_sandbox[]
	career_quest_chat											career_quest_chat[]
}

model classroom {
	classroom_id												Int       @id @default(autoincrement())
	classroom_name												String
	class_code													String		@unique

	classroom_teacher_map										classroom_teacher_map[]
	student														student[]

	created_at                                                  DateTime  @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt
}

model school {
    school_id	          										Int       @id @default(autoincrement())
	school_name													String @unique

	teachers													teacher[]

    created_at          										DateTime  @default(now())
    updated_at          										DateTime @default(now()) @updatedAt
}

model teacher {
    teacher_id          										Int       @id @default(autoincrement())
    user_id             										Int       @unique  // One teacher record per user
	teacher_first_name											String
	teacher_last_name											String
	school_id													Int

    is_approved         										Boolean?
    classroom_teacher_map   									classroom_teacher_map[]
    student_invited     										student[]
    school														school @relation(fields: [school_id], references: [school_id])

	user                                                        credentials @relation(fields: [user_id], references: [user_id])

    created_at          										DateTime  @default(now())
    updated_at          										DateTime @default(now()) @updatedAt

    @@index([school_id], name: "teacher__school_id_idx")
}

model classroom_teacher_map {
    classroom_teacher_map_id    								Int       @id @default(autoincrement())
    teacher_id                  								Int
    classroom_id                								Int
								
    created_at                  								DateTime  @default(now())
    updated_at                  								DateTime  @default(now()) @updatedAt
								
    teacher                     								teacher @relation(fields: [teacher_id], references: [teacher_id])
    classroom                   								classroom @relation(fields: [classroom_id], references: [classroom_id])

    @@unique([classroom_id, teacher_id])
    @@index([teacher_id])
    @@index([classroom_id])
}

enum InvitationMethod {
	TEACHER_INVITE
	CLASS_CODE
}

enum InvitationStatus {
    PENDING
    ACCEPTED
    DECLINED
}

model student {
    student_id              									Int       @id @default(autoincrement())
    user_id                 									Int
    classroom_id            									Int
    teacher_id_invited      									Int?
    invitation_method       									InvitationMethod
    invitation_status       									InvitationStatus @default(PENDING)
    joined_classroom_at     									DateTime? // Only set when ACCEPTED

    created_at          										DateTime  @default(now())
    updated_at          										DateTime  @default(now()) @updatedAt
										
    user                										credentials @relation(fields: [user_id], references: [user_id])
    classroom           										classroom @relation(fields: [classroom_id], references: [classroom_id])
    teacher_invited     										teacher? @relation(fields: [teacher_id_invited], references: [teacher_id])

    @@unique([user_id, classroom_id])
    @@index([classroom_id])
}
